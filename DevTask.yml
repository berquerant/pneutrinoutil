version: '3'

includes:
  ui:
    taskfile: ./ui/Taskfile.yml
    dir: ./ui

tasks:
  default:
    deps:
      - lint
      - test
      - build
  build:
    desc: Build binaries
    deps:
      - build-cli
      - build-server
      - build-worker
  build-cli:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil cli/main.go
  build-server:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil-server server/main.go
  build-worker:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil-worker worker/main.go
  build-mockcli:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil-mockcli mockcli/main.go
  lint:
    desc: Run linters
    deps:
      - vuln
      - vet
      - golangci-lint
      - go-arch-lint
      - ui:lint
  test:
    desc: Run unit tests
    deps:
      - task: stop-server
      - prepare-test-data
    cmds:
      - go test -cover -race $(go list ./... | grep -v tests) ${DEBUG+-v -count=1}
  e2e:
    desc: Run E2E tests
    deps:
      - task: stop-server
      - drop-test-data
    cmds:
      - task: prepare-test-data
      - go test -cover -race $(go list ./... | grep tests) -count=1 ${DEBUG+-v}
  vuln:
    cmds:
      - ./tools/run.sh govulncheck ./...
  vet:
    cmds:
      - go vet ./...
  golangci-lint:
    cmds:
      - ./tools/run.sh golangci-lint config verify -v
      - ./tools/run.sh golangci-lint run
  go-arch-lint:
    cmds:
      - ./tools/run.sh go-arch-lint check
      - mkdir -p tmp
      - ./tools/run.sh go-arch-lint graph -t di --out tmp/go-arch-lint.svg
  shellcheck:
    cmds:
      - ./bin/shellcheck.sh
  generate:
    desc: Go generate
    # deps:
    #   - clean-generated
    cmds:
      - go generate ./...
  clean:
    deps:
      - clean-generated
      - clean-tools
  clean-generated:
    cmds:
      - find . -name "*_generated.go" -type f -delete
  clean-tools:
    cmds:
      - rm -rf ./bin/tools
  tidy:
    cmds:
      - go mod tidy -v
  swag:
    desc: Generate API document
    cmds:
      - ./tools/run.sh swag init -g ./server/main.go -o ./server/docs
      - task: ui:swag
  start:
    desc: Start services
    deps:
      - prepare-data
    cmds:
      - task: start-server
      - task: start-worker
      - task: start-ui
  stop:
    desc: Stop services
    deps:
      - stop-worker
      - stop-server
      - stop-ui
    cmds:
      - task: drop-infra
  start-server:
    desc: Start server
    deps:
      - infra
    cmds:
      - ./bin/docker.sh up -d server
  start-worker:
    desc: Start worker
    deps:
      - infra
      - build-worker
    cmds:
      - ./bin/worker.sh start
  start-ui:
    desc: Start ui
    deps:
      - start-server
    cmds:
      - ./bin/docker.sh up -d ui
  stop-server:
    desc: Stop server
    cmds:
      - ./bin/docker.sh stop server
  stop-worker:
    desc: Stop worker
    cmds:
      - ./bin/worker.sh stop
  stop-ui:
    desc: Stop ui
    cmds:
      - ./bin/docker.sh stop ui
  restart-server:
    desc: Restart server
    deps:
      - stop-server
    cmds:
      - ./bin/docker.sh up -d server --build
  restart-worker:
    desc: Restart worker
    deps:
      - stop-worker
    cmds:
      - task: build-worker
      - task: start-worker
  restart-ui:
    desc: Restart ui
    deps:
      - stop-ui
    cmds:
      - ./bin/docker.sh up -d ui --build
  start-host-server:
    desc: Start server on host
    deps:
      - infra
    cmds:
      - ./bin/server.sh start
  stop-host-server:
    desc: Stop server on host
    cmds:
      - ./bin/server.sh stop
  restart-host-server:
    desc: Restart server on host
    deps:
      - stop-host-server
    cmds:
      - task: build-server
      - task: start-host-server
  prepare-test-data:
    desc: Prepare test data
    deps:
      - prepare-data
    cmds:
      - ./bin/ddl.sh tables test
      - ./bin/ddl.sh storage test
  prepare-data:
    desc: Prepare data
    deps:
      - infra
    cmds:
      - task: mysql
      - task: storage
  mysql:
    desc: Prepare mysql data
    cmds:
      - ./bin/retry.sh -- ./bin/ddl.sh db
      - ./bin/ddl.sh users
      - ./bin/ddl.sh tables $MYSQL_DATABASE
  storage:
    desc: Prepare storage
    cmds:
      - ./bin/ddl.sh storage
  infra:
    desc: Start docker infra
    cmds:
      - ./bin/docker.sh -f docker-infra.yml up -d
      - task: wait-infra
  wait-infra:
    desc: Wait docker infra
    deps:
      - wait-mysql
      - wait-storage
      - wait-redis
  wait-mysql:
    desc: Wait mysql
    cmds:
      - ./bin/mysql.sh wait
  wait-storage:
    desc: Wait storage
    cmds:
      - ./bin/s3.sh wait
  wait-redis:
    desc: Wait redis
    cmds:
      - ./bin/redis.sh wait
  drop-test-data:
    desc: Drop test data
    deps:
      - infra
    cmds:
      - ./bin/retry.sh -- ./bin/ddl.sh drop db test
      - ./bin/ddl.sh drop storage test
      - ./bin/ddl.sh drop kvs "${REDIS_TEST_DB}"
  drop-data:
    desc: Drop persistent data
    deps:
      - infra
    cmds::
      - task: drop-mysql
      - task: drop-storage
      - task: drop-redis
  drop-mysql:
    desc: Drop mysql data
    cmds:
      - ./bin/retry.sh -- ./bin/ddl.sh drop db "${MYSQL_DATABASE}"
  drop-storage:
    desc: Drop storage data
    cmds:
      - ./bin/ddl.sh drop storage "${STORAGE_BUCKET}"
  drop-redis:
    desc: Drop redis data
    cmds:
      - ./bin/ddl.sh drop kvs "${REDIS_DB}"
  drop-infra:
    desc: Down infra
    cmds:
      - ./bin/docker.sh -f docker-infra.yml down
