version: '3'

tasks:
  default:
    deps:
      - lint
      - test
      - build
  build:
    desc: Build binaries
    deps:
      - build-cli
      - build-server
      - build-worker
  build-cli:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil cli/main.go
  build-server:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil-server server/main.go
  build-worker:
    cmds:
      - ./bin/build.sh -o dist/pneutrinoutil-worker worker/main.go
  lint:
    desc: Run linters
    deps:
      - vuln
      - vet
      - golangci-lint
      - go-arch-lint
  test:
    desc: Run unit tests
    deps:
      - prepare-test-data
    cmds:
      - go test -cover -race $(go list ./... | grep -v tests) ${DEBUG+-v -count=1}
  e2e:
    desc: Run E2E tests
    deps:
      - drop-test-data
    cmds:
      - task: prepare-test-data
      - go test -cover -race $(go list ./... | grep tests) -count=1 ${DEBUG+-v}
  vuln:
    cmds:
      - ./tools/run.sh govulncheck ./...
  vet:
    cmds:
      - go vet ./...
  golangci-lint:
    cmds:
      - ./tools/run.sh golangci-lint config verify -v
      - ./tools/run.sh golangci-lint run
  go-arch-lint:
    cmds:
      - ./tools/run.sh go-arch-lint check
      - mkdir -p tmp
      - ./tools/run.sh go-arch-lint graph -t di --out tmp/go-arch-lint.svg
  shellcheck:
    cmds:
      - ./bin/shellcheck.sh
  generate:
    desc: Go generate
    # deps:
    #   - clean-generated
    cmds:
      - go generate ./...
  clean:
    deps:
      - clean-generated
      - clean-tools
  clean-generated:
    cmds:
      - find . -name "*_generated.go" -type f -delete
  clean-tools:
    cmds:
      - rm -rf ./bin/tools
  tidy:
    cmds:
      - go mod tidy -v
  swag:
    desc: Generate API document
    cmds:
      - ./tools/run.sh swag init -g ./server/main.go -o ./server/docs
  start:
    desc: Start servers
    deps:
      - prepare-data
    cmds:
      - ./tools/run.sh goreman -b $GOREMAN_BASE_PORT start
  prepare-test-data:
    desc: Prepare test data
    deps:
      - prepare-data
    cmds:
      - ./bin/ddl.sh tables test
      - ./bin/ddl.sh storage test
  prepare-data:
    desc: Prepare data
    deps:
      - services
    cmds:
      - task: mysql
      - task: storage
  mysql:
    desc: Prepare mysql data
    cmds:
      - ./bin/retry.sh -- ./bin/ddl.sh db
      - ./bin/ddl.sh users
      - ./bin/ddl.sh tables $MYSQL_DATABASE
  storage:
    desc: Prepare storage
    cmds:
      - ./bin/ddl.sh storage
  services:
    desc: Start docker services
    cmds:
      - ./bin/docker.sh up -d
      - task: wait-services
  wait-services:
    desc: Wait docker services
    deps:
      - wait-mysql
      - wait-storage
      - wait-redis
  wait-mysql:
    desc: Wait mysql
    cmds:
      - ./bin/mysql.sh wait
  wait-storage:
    desc: Wait storage
    cmds:
      - ./bin/s3.sh wait
  wait-redis:
    desc: Wait redis
    cmds:
      - ./bin/redis.sh wait
  drop-test-data:
    desc: Drop test data
    deps:
      - services
    cmds:
      - ./bin/retry.sh -- ./bin/ddl.sh drop db test
      - ./bin/ddl.sh drop storage test
      - ./bin/ddl.sh drop kvs "${REDIS_TEST_DB}"
  drop-data:
    desc: Drop persistent data
    deps:
      - services
    cmds::
      - task: drop-mysql
      - task: drop-storage
      - task: drop-redis
  drop-mysql:
    desc: Drop mysql data
    cmds:
      - ./bin/retry.sh -- ./bin/ddl.sh drop db "${MYSQL_DATABASE}"
  drop-storage:
    desc: Drop storage data
    cmds:
      - ./bin/ddl.sh drop storage "${STORAGE_BUCKET}"
  drop-redis:
    desc: Drop redis data
    cmds:
      - ./bin/ddl.sh drop kvs "${REDIS_DB}"
  down-services:
    desc: Down services
    cmds:
      - ./bin/docker.sh down
